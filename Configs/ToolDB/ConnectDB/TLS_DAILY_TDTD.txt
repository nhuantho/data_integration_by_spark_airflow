--HĐ THÀNH CÔNG-- ( SELECT WLSWF .LOAN_CODE , WLSWF .INTEGRATION_ID , WLSWF .CREATED_DT , WLSWF .0x93ACTION0x93 , G.GRP_NM STATUS, G2.GRP_NM STATUS_DTL, NULL CANCEL_REASON, NULL REJECT_REASON, NULL REQUEST_REASON, NULL REASON_DETAIL, CAST(C.SHOP_CURRENT_WID AS VARCHAR(30)) SHOP_CODE, C.SHOP_NAME , C.CALLER_CODE, C.CALLER_NAME, WED.EMPLOYEE_CODE , WED.EMPLOYEE_NM, C.CAMPAIGN, C.NHOM_NGUON, C.NGUON_PHU, C.PHAN_LOAI_NGUON_PHU, C.DISBURSE_DT, C.MONEY FROM F88DWH.W_LOAN_STATE_WORKFLOW_F WLSWF INNER JOIN (SELECT LOAN_CODE FROM F88DWH.W_LOAN_DTL_F WHERE CHANNEL_CODE LIKE 0x91%E2E%0x91 AND CREATED_DT >= TO_DATE(:DAY1,0x91YYYY-MM-DD0x91)) LDT ON WLSWF .LOAN_CODE = LDT.LOAN_CODE INNER JOIN --LẤY THEO TRẠNG THÁI CUỐI CÙNG (SELECT LOAN_CODE, MAX(INTEGRATION_ID) MAX_ID FROM F88DWH.W_LOAN_STATE_WORKFLOW_F WHERE EMPLOYEE_WID_UPDATE IS NOT NULL AND TO_DATE(CREATED_DT) >= TO_DATE(:DAY1,0x91YYYY-MM-DD0x91) GROUP BY LOAN_CODE) M ON WLSWF.LOAN_CODE = M.LOAN_CODE AND WLSWF.INTEGRATION_ID = M.MAX_ID LEFT JOIN F88DWH.W_SHOP_D WSD ON WLSWF .SHOP_WID = WSD.SHOP_WID LEFT JOIN F88DWH.W_EMPLOYEE_D WED ON WLSWF .EMPLOYEE_WID_UPDATE = WED.EMPLOYEE_WID LEFT JOIN F88DWH.GRP G ON WLSWF .WORK_FLOW_STATUS_WID = G.GRP_ID LEFT JOIN F88DWH.GRP G2 ON WLSWF .STATE_WORK_FLOW_WID = G2.GRP_ID LEFT JOIN --LẤY TÊN TLS (SELECT * FROM F88DWH.W_PAWN_ONLINE_TLS_F WPOTF WHERE DISBURSE_DT >= TO_DATE(:DAY1,0x91YYYY-MM-DD0x91)) C ON WLSWF .LOAN_CODE = C.CONTRACT_NO WHERE TO_DATE(WLSWF.CREATED_DT) >= TO_DATE(:DAY1,0x91YYYY-MM-DD0x91) AND WLSWF.EMPLOYEE_WID_UPDATE IS NOT NULL AND WLSWF. LOAN_WID IS NOT NULL ) UNION --HĐ CHƯA THÀNH CÔNG-- ( SELECT WLSWF .LOAN_CODE , WLSWF .INTEGRATION_ID , WLSWF .CREATED_DT , WLSWF .0x93ACTION0x93 , G.GRP_NM STATUS, G2.GRP_NM STATUS_DTL, WRCD.NAME CANCEL_REASON, WRRD.NAME REJECT_REASON, WRRD2.REASON_REQUEST_NM REQUEST_REASON, WLSWF .REASON REASON_DETAIL, WSD.SHOP_CODE, WSD.SHOP_NM , C.TLS_USER, C.TLS_NAME, WED.EMPLOYEE_CODE , WED.EMPLOYEE_NM , NULL ,NULL ,NULL ,NULL ,NULL, NULL FROM F88DWH.W_LOAN_STATE_WORKFLOW_F WLSWF INNER JOIN --LẤY THEO TRẠNG THÁI CUỐI CÙNG (SELECT LOAN_CODE, MAX(INTEGRATION_ID) MAX_ID FROM F88DWH.W_LOAN_STATE_WORKFLOW_F WHERE EMPLOYEE_WID_UPDATE IS NOT NULL AND TO_DATE(CREATED_DT) >= TO_DATE(:DAY1,0x91YYYY-MM-DD0x91) GROUP BY LOAN_CODE) M ON WLSWF.LOAN_CODE = M.LOAN_CODE AND WLSWF.INTEGRATION_ID = M.MAX_ID LEFT JOIN F88DWH.W_SHOP_D WSD ON WLSWF .SHOP_WID = WSD.SHOP_WID LEFT JOIN F88DWH.W_EMPLOYEE_D WED ON WLSWF .EMPLOYEE_WID_UPDATE = WED.EMPLOYEE_WID LEFT JOIN F88DWH.GRP G ON WLSWF .WORK_FLOW_STATUS_WID = G.GRP_ID LEFT JOIN F88DWH.GRP G2 ON WLSWF .STATE_WORK_FLOW_WID = G2.GRP_ID LEFT JOIN --ĐI TÌM LÝ DO (SELECT WLRF2.STATE_WORKFLOW_ID , WLRF2.REASON_REQUEST_WID , WLRF2.REASON_REJECT_WID , WLRF2.REASON_CANCEL_WID FROM F88DWH.W_LOAN_REASON_F WLRF2 INNER JOIN (SELECT STATE_WORKFLOW_ID , MAX(INTEGRATION_ID) MAX_ID2 FROM F88DWH.W_LOAN_REASON_F GROUP BY STATE_WORKFLOW_ID) A ON WLRF2 .STATE_WORKFLOW_ID = A.STATE_WORKFLOW_ID AND WLRF2 .INTEGRATION_ID = A.MAX_ID2 WHERE WLRF2.CREATED_DT >= TO_DATE(:DAY1,0x91YYYY-MM-DD0x91)) B ON WLSWF .INTEGRATION_ID = B.STATE_WORKFLOW_ID LEFT JOIN F88DWH.W_REASON_CANCEL_D WRCD ON B .REASON_CANCEL_WID = WRCD.REASON_CANCEL_WID LEFT JOIN F88DWH.W_REASON_REJECT_D WRRD ON B .REASON_REJECT_WID = WRRD.REASON_REJECT_WID LEFT JOIN F88DWH.W_REASON_REQUEST_D WRRD2 ON B .REASON_REQUEST_WID = WRRD2.REASON_REQUEST_WID LEFT JOIN --LẤY TÊN TLS (SELECT WLSWF3.LOAN_CODE , WED1.EMPLOYEE_CODE TLS_USER, WED1.EMPLOYEE_NM TLS_NAME, WED1.DEPARTMENT_NM FROM F88DWH.W_LOAN_STATE_WORKFLOW_F WLSWF3 LEFT JOIN F88DWH.W_EMPLOYEE_D WED1 ON WLSWF3.EMPLOYEE_WID_UPDATE = WED1.EMPLOYEE_WID WHERE WLSWF3. 0x93ACTION0x93 = 0x91SAVE0x91 AND WLSWF3 .CREATED_DT >= TO_DATE(:DAY1,0x91YYYY-MM-DD0x91)) C ON WLSWF .LOAN_CODE = C.LOAN_CODE WHERE TO_DATE(WLSWF.CREATED_DT) >= TO_DATE(:DAY1,0x91YYYY-MM-DD0x91) AND WLSWF.EMPLOYEE_WID_UPDATE IS NOT NULL AND WLSWF. LOAN_WID IS NULL AND LOWER(WSD.SHOP_NM) LIKE 0x91%TELE%0x91 ) UNION --REQUEST KO CÓ SHOP_NAME ( SELECT WLSWF .LOAN_CODE , WLSWF .INTEGRATION_ID , WLSWF .CREATED_DT , WLSWF .0x93ACTION0x93 , G.GRP_NM STATUS, G2.GRP_NM STATUS_DTL, WRCD.NAME CANCEL_REASON, WRRD.NAME REJECT_REASON, WRRD2.REASON_REQUEST_NM REQUEST_REASON, WLSWF .REASON REASON_DETAIL, WSD.SHOP_CODE, WSD.SHOP_NM , C.TLS_USER, C.TLS_NAME, WED.EMPLOYEE_CODE , WED.EMPLOYEE_NM, NULL ,NULL ,NULL ,NULL ,NULL, NULL FROM F88DWH.W_LOAN_STATE_WORKFLOW_F WLSWF INNER JOIN --LẤY THEO TRẠNG THÁI CUỐI CÙNG (SELECT LOAN_CODE, MAX(INTEGRATION_ID) MAX_ID FROM F88DWH.W_LOAN_STATE_WORKFLOW_F WHERE EMPLOYEE_WID_UPDATE IS NOT NULL AND TO_DATE(CREATED_DT) >= TO_DATE(:DAY1,0x91YYYY-MM-DD0x91) GROUP BY LOAN_CODE) M ON WLSWF.LOAN_CODE = M.LOAN_CODE AND WLSWF.INTEGRATION_ID = M.MAX_ID INNER JOIN --LẤY TÊN TLS (SELECT WLSWF3.LOAN_CODE , WED1.EMPLOYEE_CODE TLS_USER, WED1.EMPLOYEE_NM TLS_NAME FROM F88DWH.W_LOAN_STATE_WORKFLOW_F WLSWF3 LEFT JOIN F88DWH.W_EMPLOYEE_D WED1 ON WLSWF3.EMPLOYEE_WID_UPDATE = WED1.EMPLOYEE_WID WHERE WLSWF3. 0x93ACTION0x93 = 0x91SAVE0x91 AND WLSWF3 .CREATED_DT >= TO_DATE(:DAY1,0x91YYYY-MM-DD0x91) AND LOWER(WED1.DEPARTMENT_NM) LIKE 0x91%BÁN HÀNG QUA ĐIỆN THOẠI%0x91) C ON WLSWF .LOAN_CODE = C.LOAN_CODE LEFT JOIN F88DWH.W_SHOP_D WSD ON WLSWF .SHOP_WID = WSD.SHOP_WID LEFT JOIN F88DWH.W_EMPLOYEE_D WED ON WLSWF .EMPLOYEE_WID_UPDATE = WED.EMPLOYEE_WID LEFT JOIN F88DWH.GRP G ON WLSWF .WORK_FLOW_STATUS_WID = G.GRP_ID LEFT JOIN F88DWH.GRP G2 ON WLSWF .STATE_WORK_FLOW_WID = G2.GRP_ID LEFT JOIN --ĐI TÌM LÝ DO (SELECT WLRF2.STATE_WORKFLOW_ID , WLRF2.REASON_REQUEST_WID , WLRF2.REASON_REJECT_WID , WLRF2.REASON_CANCEL_WID FROM F88DWH.W_LOAN_REASON_F WLRF2 INNER JOIN (SELECT STATE_WORKFLOW_ID , MAX(INTEGRATION_ID) MAX_ID2 FROM F88DWH.W_LOAN_REASON_F GROUP BY STATE_WORKFLOW_ID) A ON WLRF2 .STATE_WORKFLOW_ID = A.STATE_WORKFLOW_ID AND WLRF2 .INTEGRATION_ID = A.MAX_ID2 WHERE WLRF2.CREATED_DT >= TO_DATE(:DAY1,0x91YYYY-MM-DD0x91)) B ON WLSWF .INTEGRATION_ID = B.STATE_WORKFLOW_ID LEFT JOIN F88DWH.W_REASON_CANCEL_D WRCD ON B .REASON_CANCEL_WID = WRCD.REASON_CANCEL_WID LEFT JOIN F88DWH.W_REASON_REJECT_D WRRD ON B .REASON_REJECT_WID = WRRD.REASON_REJECT_WID LEFT JOIN F88DWH.W_REASON_REQUEST_D WRRD2 ON B .REASON_REQUEST_WID = WRRD2.REASON_REQUEST_WID WHERE TO_DATE(WLSWF.CREATED_DT) >= TO_DATE(:DAY1,0x91YYYY-MM-DD0x91) AND WLSWF.EMPLOYEE_WID_UPDATE IS NOT NULL AND WLSWF. LOAN_WID IS NULL AND WLSWF .SHOP_WID IS NULL )